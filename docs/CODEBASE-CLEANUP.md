# コードベース整理ステップ（安全に進めるための手順）

## ゴール
- 既存機能を壊さずにスパゲッティ化を抑制し、構造とドキュメントを整理する。

## 0. 安全網
- `npm run lint` / `npm run build` を基準チェックにする。
- 手動スモーク: ログイン → ダッシュボード → sites/templates/inspections → 承認/レポートの主要画面が開くか。
- 必要に応じて簡易E2Eシナリオをメモ（テスト化は任意）。

## 1. 依存・設定の整理
- `package.json` スクリプトの役割を明確化（dev/build/lint/test など重複除去）。
- `.env.example` を最新化（必須/任意変数にコメント）。
- `next.config.ts` / lint 設定の不要項目がないか確認。

## 2. ディレクトリ/責務の分離
- `src/types` に共通型を集約し、API/フロントで同じ型を共有する（users/organization/template/site/inspection）。
- `src/lib` に認可・組織/ユーザー取得の共通ヘルパーを集約（APIごとの重複ロジックを削減）。
- UI: 共通コンポーネント（ボタン/タグ/ステータス/フォーム入力）を `src/components` へまとめ、ページ固有のスタイルを分離。

## 3. APIの共通化
- エラーレスポンスの形式を統一（`{ error, details?, code? }`）。invite, org設定, templates などでバラつきを解消。
- Supabaseアクセスの共通ヘルパーを使って `auth.getUser`/組織確認/ロール確認の重複除去。
- ストレージ用ユーティリティ（ロゴ/写真バケット）を一箇所で管理し、呼び出し側を差し替える。

## 4. 未使用コードの削除
- `ts-prune` や `eslint --report-unused-disable-directives` で未使用コンポーネント/型/関数を検出して削除。
- 不要ドキュメントや古いSQLは `docs/archive` へ移動し、現行版へのリンクをREADMEに残す。

## 5. ドキュメントの整理
- README の導線を一本化（セットアップ→DB→機能→開発ロードマップ→招待手順）。
- 役割別ガイドを小さく分離（例: 招待/初期設定、DB手順、レイアウトガイド）。
- 変更後は対象ドキュメントから古い記述を取り除き、アーカイブへ移動。

## 6. 段階的コミット
- 「依存/設定」「API共通化」「UI共通化」「未使用削除」「ドキュメント」など小さなまとまりでコミット。
- 各コミット後に lint/build/スモークを実行し、リグレッションを防ぐ。

## フェーズ順の目安
1. 安全網＋依存/設定の整理
2. 型/ユーティリティの共通化（API側の重複削減）
3. UIコンポーネントの共通化（大きい場合は後ろに回す）
4. 未使用コード/ドキュメント整理
5. README・ガイドの更新
