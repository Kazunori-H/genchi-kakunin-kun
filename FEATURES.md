# 機能一覧

## 📊 システム概要

産業廃棄物処理業者の現地確認記録を作成・管理するためのWebアプリケーション

---

## ✅ 実装済み機能

### 1. 認証・組織管理

- **マルチテナント対応**: 組織ごとにデータを分離
- **ユーザー認証**: Supabase Authによる認証
- **Row Level Security (RLS)**: データベースレベルでのアクセス制御

### 2. 現地確認先管理 (`/sites`)

#### 基本機能
- 現地確認先の登録・編集・削除・一覧表示
- 施設情報（名称、住所、連絡先）の管理

#### 施設種別（複数選択対応）
- ✅ 運搬（車両基地など）
- ✅ 積替保管施設
- ✅ 中間処理施設
- ✅ 最終処分場

→ 1つの施設に複数の種別を設定可能

### 3. チェックシートテンプレート管理 (`/templates`)

#### テンプレート基本機能
- テンプレートの作成・編集・削除・一覧表示
- テンプレート項目の動的追加・削除・並び替え
- デフォルトテンプレート設定

#### システムテンプレート
- **基本テンプレート**: すべての組織で利用可能な標準チェックシート
- **編集・削除不可**: システムテンプレートは保護されている
- **複製可能**: システムテンプレートを複製してカスタマイズ可能

#### テンプレート複製機能
- テンプレート詳細ページから複製
- テンプレート一覧ページから複製
- すべての項目・設定が完全にコピーされる

#### チェックリスト項目の条件付き表示
- **施設種別による表示制御**: 各チェックリスト項目に「表示する施設種別」を設定可能
- **OR条件**: 施設が複数種別を持つ場合、いずれかに該当すれば表示
- **共通項目**: 表示条件未設定の項目はすべての施設種別で表示

**例**:
```
施設A: facility_types = ['transport', 'intermediate_treatment']

チェックリスト項目:
- 項目1 (display_facility_types = []) → ✅ 表示（共通項目）
- 項目2 (display_facility_types = ['transport']) → ✅ 表示
- 項目3 (display_facility_types = ['intermediate_treatment']) → ✅ 表示
- 項目4 (display_facility_types = ['final_disposal']) → ❌ 非表示
```

#### 対応項目タイプ
- テキスト入力
- テキストエリア
- 選択式（OK/NG/該当なし）
- 数値入力
- 日付入力
- 写真添付
- セクションヘッダー（見出し）
- 5段階評価 + N/A (`rating_1_5_na`)

### 4. 確認記録管理 (`/inspections`)

#### 記録の作成・編集
- 現地確認先とテンプレートの選択
- 確認実施日の設定
- サマリー（概要）の記入

#### 概要情報の管理
- **時刻情報**: 開始時刻、終了時刻（所要時間を自動計算）
- **立会者情報**: 氏名、所属、役職（複数名対応、動的追加・削除）
- **概要編集**: 専用の編集ページ (`/inspections/[id]/edit`)

#### チェックリスト入力
- テンプレートに基づいたチェック項目の表示
- **施設種別による項目フィルタリング**: 施設の種別に応じて必要な項目のみ表示
- 各項目タイプに応じた入力UI
- 必須項目のバリデーション
- 写真のアップロード・プレビュー

#### 確認記録の表示
- サマリーページ (`/inspections/[id]`):
  - ステータス管理
  - 施設情報（施設種別タグ表示）
  - 概要情報（時刻、立会者）
  - チェックリスト結果の一覧表示
  - 写真添付セクションで補足資料を一括管理（複数ファイル対応、ドラフト時のみ編集可能）
  - PDF/CSVエクスポートボタン（ホバー時カーソル変更対応）
  - 削除ボタン（下書き・作成者のみ表示）
  - 承認申請ボタン（下書き・作成者のみ表示、必須項目バリデーション付き）

#### 確認記録の削除
- **権限制御**: 下書き状態の記録のみ、作成者のみが削除可能
- **削除確認**: 削除前に確認ダイアログを表示
- **配置**: サマリーページのPDF/CSVボタンと同列に配置

#### 確認記録一覧のフィルター機能
- **カード式UI**: フィルター条件をカード形式で見やすく表示
- **ステータスフィルター**: ボタン式で視覚的に選択状態を表示（ホバー時カーソル変更）
- **現地確認先フィルター**: 施設ごとの絞り込み
- **日付範囲フィルター**: 開始日・終了日での絞り込み
- **フィルタークリア**: ワンクリックで全フィルターをクリア

### 5. 承認ワークフロー

#### ステータス管理
- `draft`: 下書き（編集可能）
- `submitted`: 承認申請中（編集不可）
- `approved`: 承認済み
- `rejected`: 却下（下書きに戻る）

#### 承認フロー
1. **申請**: 下書きから承認申請（サマリーページから直接申請可能）
2. **承認**: 承認者による承認
3. **却下**: 承認者による却下（コメント必須）
4. **取り下げ**: 申請者による取り下げ（下書きに戻る）

#### 承認申請機能
- **サマリーページから申請**: チェックリストページに移動せずに申請可能
- **自動バリデーション**: 必須項目（チェックリスト + 確認実施日）の自動チェック
- **確認ダイアログ**: 申請前に編集不可の警告を表示
- **権限制御**: 下書きの作成者のみ申請ボタンを表示

#### 承認設定
- 組織ごとに必要な承認者数を設定
- 承認者の指定（複数可）

#### 承認アクション
- 承認リクエストの作成・更新
- 承認アクションの記録（承認/却下/取り下げ）
- コメント機能

### 6. レイアウト・UI/UX

#### 統一レイアウト
- **DashboardLayout**: 全認証後ページで統一されたヘッダーレイアウト
- **ナビゲーションメニュー**: ダッシュボード、現地確認先、テンプレート、確認記録
- **アカウントメニュー**: プロフィール設定、組織設定（管理者のみ）、ログアウト
- **レイアウトガイド**: LAYOUT-GUIDE.mdで使用方法を文書化

#### UI/UX改善
- **ホバー時カーソル変更**: PDF/CSV/ステータスボタンでポインターカーソルを表示
- **視覚的フィードバック**: ボタンの選択状態を明確に表示
- **ボタン配置の最適化**: 関連機能を同列に配置（PDF/CSV/削除）

### 7. その他の機能

- **リアルタイム更新**: ステータス変更時の即時反映
- **レスポンシブデザイン**: モバイル・タブレット対応
- **エラーハンドリング**: 詳細なエラーメッセージ表示

---

## 🗂 データ構造

### 主要テーブル

- `organizations`: 組織情報
- `users`: ユーザー情報
- `sites`: 現地確認先（`facility_types: TEXT[]`）
- `templates`: チェックシートテンプレート（`is_system_template: BOOLEAN`）
- `template_items`: テンプレート項目（`display_facility_types: JSONB`）
- `inspections`: 確認記録（`overview_metadata: JSONB`）
- `inspection_responses`: チェック項目の回答
- `approval_settings`: 承認設定
- `approval_requests`: 承認リクエスト
- `approval_actions`: 承認アクション

---

## 🔐 セキュリティ

- **認証**: Supabase Auth
- **RLS**: すべてのテーブルにRow Level Securityを適用
- **組織分離**: 組織IDによるデータ分離
- **システムテンプレート保護**: is_system_template = true のレコードは編集・削除不可

---

## 📱 画面一覧

### 現地確認先
- `/sites` - 一覧
- `/sites/new` - 新規登録
- `/sites/[id]` - 詳細
- `/sites/[id]/edit` - 編集

### テンプレート
- `/templates` - 一覧
- `/templates/new` - 新規作成
- `/templates/[id]` - 詳細
- `/templates/[id]/edit` - 編集

### 確認記録
- `/inspections` - 一覧
- `/inspections/new` - 新規作成
- `/inspections/[id]` - サマリー（詳細）
- `/inspections/[id]/edit` - 概要編集
- `/inspections/[id]/checklist` - チェックリスト入力

---

## 🎯 ユースケース

### 1. システムテンプレートから始める
1. 「基本テンプレート」を複製
2. 自社用にカスタマイズ（項目の追加・削除）
3. 各項目に施設種別の表示条件を設定
4. 現地確認記録を作成

### 2. 施設種別ごとの確認項目管理
1. 施設登録時に複数の種別を選択（例: 運搬 + 中間処理）
2. テンプレート編集で各項目の表示条件を設定
3. チェックリスト入力時、自動的に該当項目のみ表示

### 3. 承認フロー
1. 確認記録を作成（下書き）
2. チェックリスト入力
3. 概要情報を入力
4. 承認申請
5. 承認者が承認/却下
6. 必要に応じて取り下げ

---

## 🔄 最新のアップデート

### 2025-11-20
- ✅ 確認記録の削除機能（下書き・作成者のみ）
- ✅ サマリーページからの承認申請機能（必須項目バリデーション付き）
- ✅ 確認記録一覧のフィルターUI刷新（カード式レイアウト）
- ✅ ホバー時カーソル変更（PDF/CSV/ステータスボタン）
- ✅ DashboardLayoutの全ページ統一適用
- ✅ LAYOUT-GUIDE.mdの作成
- ✅ チェックリスト編集ボタンの配置最適化
- ✅ フィルタークリア機能の追加
- ✅ CSV出力の最適化（不要列削除）

### 2025-01-19
- ✅ テンプレート複製機能（一覧・詳細）
- ✅ システムテンプレートのアクセス修正（ORフィルタ）
- ✅ エラーログ改善

### 2025-01-18
- ✅ 施設種別の複数選択対応
- ✅ チェックリスト項目の条件付き表示（OR条件）
- ✅ 確認記録の概要情報（時刻、立会者）

### 過去のアップデート
- 承認ワークフロー実装
- システムテンプレート機能
- 基本テンプレート投入
