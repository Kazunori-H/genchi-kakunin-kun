# 現地確認くん - 開発ロードマップ

## 進捗サマリー（2025-11-20時点）
- **Phase 0-2**: 基盤構築〜マスターデータ管理は完了し、施設・テンプレート管理は運用レベルで利用可能。
- **Phase 3**: 確認記録の作成〜提出フローとチェックリストUIは稼働中。写真アップロードと自動保存も完了。フェーズ3は完了。
- **Phase 4**: 確認記録の一覧・詳細表示、概要編集機能に加えてフィルタ・ページネーション・編集履歴表示まで完了。下書きの削除機能も実装済み。フェーズ4は完了。
- **Phase 5**: 単段の承認申請〜承認/却下/差戻し/取り下げと履歴表示に加えて、承認レベル設定と承認者権限管理を実装済み。サマリーページからの承認申請機能も完了。通知機能と多段承認の詳細運用は未着手。
- **Phase 6**: レポート機能完了。統計ダッシュボード、評価分布チャート、PDF/CSV出力が利用可能。
- **Phase 7**: アカウントメニューと個人/組織設定の導線を整備済み。共通ヘッダーレイアウト（DashboardLayout）を全ページに統一し、一貫性のあるUIを実現。ユーザー招待や詳細な管理画面はこれから実装。
- **Phase 8**: UI/UX改善として、フィルタUIの刷新、カーソル変更、ボタン配置の最適化を実施済み。

## 完了済み機能 ✅

### Phase 0: 基盤構築
- [x] プロジェクト初期設定（Next.js, TypeScript, Tailwind CSS v4）
- [x] Supabase設定（認証、データベース）
- [x] データベース設計とマイグレーション
- [x] RLSポリシーの設定

### Phase 1: 認証・基本機能
- [x] ユーザー登録（組織自動作成）
- [x] ログイン・ログアウト
- [x] メール確認機能
- [x] 認証コールバック処理
- [x] ダッシュボードレイアウト
- [x] 統一されたナビゲーションヘッダー

### Phase 2: マスターデータ管理
- [x] 現地確認先（sites）の一覧表示
- [x] 現地確認先の登録・編集・削除
- [x] テンプレート管理機能
- [x] テンプレートの作成・編集・削除
- [x] 基本テンプレート（システムテンプレート）の実装
  - [x] 69項目のチェック項目
  - [x] 編集・削除の防止
  - [x] 固定表示

### Phase 6: レポート機能
- [x] レポート画面のデザインと統計ダッシュボード
- [x] 統計サマリー表示（総記録数、承認済み、平均完了率など）
- [x] 評価分布グラフ（Recharts）
- [x] CSV出力機能（BOM付きUTF-8、Excel対応）
- [x] CSV出力の最適化（不要な列の削除）
- [x] PDF出力機能（jsPDF + jspdf-autotable）
- [x] 最近の確認記録一覧

### Phase 7: レイアウト・UI統一
- [x] 共通ヘッダーレイアウト（DashboardLayout）の実装
- [x] 全ページへの統一レイアウト適用
- [x] レイアウト使用ガイド（LAYOUT-GUIDE.md）の作成
- [x] ナビゲーションメニューの整理

### Phase 8: UI/UX改善
- [x] 確認記録一覧のフィルターUI改善（カード式レイアウト）
- [x] ステータスボタンのホバー時カーソル変更
- [x] エクスポートボタンのホバー時カーソル変更
- [x] チェックリスト編集ボタンの配置最適化
- [x] フィルタークリア機能の追加

---

## 今後の開発スケジュール 📅

### Phase 3: 確認記録の基本機能（最優先）🔥

**目標**: チェックシートを使った現地確認の実施と記録  
**進捗**: 3-1/3-4 は本番運用中。チェックリスト編集時の自動保存も稼働済み。写真添付はサマリーに集約。フェーズ3は完了。

#### 3-1. 確認記録の新規作成
- [x] 確認記録一覧ページの作成
- [x] 新規確認作成画面
  - [x] 現地確認先の選択
  - [x] テンプレートの選択
  - [x] 確認日の設定
  - [x] 確認者の自動設定

#### 3-2. チェックシート入力機能
- [x] チェック項目の表示
  - [x] セクションヘッダーの表示
  - [x] 評価項目の表示（1-5評価 + 該当なし）
  - [x] 必須項目のバリデーション
- [x] 評価入力UI
  - [x] ラジオボタンまたはレーティングコンポーネント
  - [x] 該当なし選択の制御
  - [x] 入力状態の保存
- [x] メモ・コメント入力欄
- [x] 下書き保存機能
- [x] 自動保存機能（オプション）

#### 3-3. 写真アップロード機能（サマリーに集約）
- [x] Supabase Storageの設定
- [x] 写真アップロードUI（確認記録サマリー）
- [x] サマリー写真の一覧表示（サムネイル）
- [x] 写真の削除
- [x] 画像圧縮（アップロード前のクライアント圧縮）

#### 3-4. 確認記録の保存と提出
- [x] 下書き状態での保存
- [x] 入力検証（必須項目チェック）
- [x] 提出機能
- [x] 提出確認ダイアログ

**残タスクの推定工数**: なし（Phase 3 完了）

---

### Phase 4: 確認記録の閲覧・管理

**目標**: 記録の検索性と可読性を高め、編集権限を整理する  
**進捗**: 一覧・フィルタ・ページネーション、サマリーでのメモ/写真表示、編集履歴タイムラインを提供済み。フェーズ4は完了。

#### 4-1. 確認記録一覧
- [x] 自分が作成した確認記録の一覧
- [x] ステータス別フィルタ（下書き、提出済み、承認済み）
- [x] 日付範囲での絞り込み
- [x] 現地確認先での絞り込み
- [x] ページネーション

#### 4-2. 確認記録詳細表示
- [x] チェック結果の表示
- [x] 評価の集計表示
- [x] 写真の表示（サマリー添付のサムネイル一覧）
- [x] メモの表示（項目ごとのメモ表示）
- [x] 確認者情報の表示

#### 4-3. 確認記録の編集
- [x] 下書き状態の編集（概要・時刻・立会者）
- [x] 提出後の編集制限
- [x] 編集履歴（オプション）

#### 4-4. 確認記録の削除
- [x] 下書き状態の削除機能
- [x] 作成者のみ削除可能な権限制御
- [x] 削除確認ダイアログ
- [x] サマリーページへの削除ボタン配置

**残タスクの推定工数**: なし（Phase 4 完了）

---

### Phase 5: 承認フロー機能

**目標**: 現地確認の承認を組織ルールに合わせて運用できる状態にする  
**進捗**: 単段承認（申請/承認/差戻し/却下/取り下げ）と履歴表示は稼働済み。多段承認設定・承認者管理・通知は未実装。

#### 5-1. 承認レベル設定
- [x] 組織の承認レベル設定（0-3段階）
- [x] ユーザーへの承認レベル割り当て
- [x] 承認権限の管理（UI/設定画面）

#### 5-2. 承認プロセス
- [x] 承認待ち一覧の表示（/approvals）
- [x] 承認・却下・差戻し機能
- [x] 承認コメント機能
- [x] サマリーページからの承認申請機能
- [x] 必須項目バリデーション（チェックリスト + 確認実施日）
- [x] 承認申請確認ダイアログ
- [ ] 承認通知（メール通知 or アプリ内通知）
- [ ] 承認待ちのバッチ処理/リマインド

#### 5-3. 承認履歴
- [x] 承認ログの記録
- [x] 承認履歴の表示
- [x] 承認者の表示

**残タスクの推定工数**: 1〜2週間（承認レベル設定 + 通知 + 権限管理UI）

---

### Phase 6: レポート機能 ✅

**目標**: 確認記録の統計レポートと出力機能の提供
**進捗**: 完了。統計ダッシュボード、評価分布チャート、PDF/CSVエクスポートが利用可能。

#### 6-1. 確認結果レポート
- [x] レポート画面のデザイン
- [x] チェック結果のサマリー表示（統計カード）
- [x] グラフ・チャート表示
  - [x] 評価分布（Rechartsによる棒グラフ）
  - [ ] 経年変化（オプション - 将来実装）
  - [ ] 現地確認先別比較（オプション - 将来実装）

#### 6-2. PDF出力
- [x] PDF生成機能（jsPDF + jspdf-autotable）
- [x] レポートのPDF化（統計サマリー + 評価分布）
- [ ] 写真付きPDF（オプション - 将来実装）
- [ ] カスタマイズ可能なテンプレート（オプション - 将来実装）

#### 6-3. データエクスポート
- [x] CSV出力（BOM付きUTF-8、Excel対応）
- [ ] Excel出力（オプション - 将来実装）

**実装完了日**: 2025-11-19
**実装内容**:
- `/api/reports/stats` - 統計データAPI
- `/api/reports/recent` - 最近の確認記録API
- `/api/reports/evaluation-distribution` - 評価分布データAPI
- `/api/reports/export/csv` - CSVエクスポートAPI
- `/reports` - レポートダッシュボードページ

---

### Phase 7: 組織・ユーザー管理

**進捗**: アカウントメニュー/個人設定/組織設定（承認設定含む）完了。ユーザー招待UI実装済み（/settings/users）。Supabase招待メール連携を調整中（招待リンクからセッション確立→/settings/profileへの遷移を継続確認中）。

#### 7-1. 組織設定
- [x] 組織情報の編集
- [x] 承認レベル設定
- [x] ロゴアップロード
- [x] 組織設定の保存

#### 7-2. ユーザー管理
- [x] ユーザー一覧表示
- [x] ユーザーの招待
- [x] ロール・権限の変更
- [x] ユーザーの無効化
- [ ] 招待メールからの初回セッション確立動作安定化（Supabase招待→/auth/callback→/settings/profile）

#### 7-3. プロフィール機能
- [x] プロフィール編集
- [x] パスワード変更
- [x] メールアドレス変更

#### 7-4. アカウントメニューと組織設定
- [x] ヘッダー右上のアカウントアイコンとドロップダウンメニュー実装（メール・組織名・各リンク）
- [x] 個人設定/プロフィール画面への導線を統合
- [x] 組織設定（承認設定含む）への導線を管理者限定で表示
- [x] メニューからのログアウト操作を統一

#### 7-5. レイアウトの統一
- [x] DashboardLayoutコンポーネントの作成
- [x] 全認証後ページへの統一レイアウト適用
- [x] LAYOUT-GUIDE.mdの作成
- [x] ナビゲーションメニューの整理（承認待ちメニュー削除）

**推定工数**: 1週間（完了）

---

### Phase 8: UI/UX改善と最適化

#### 8-1. UI改善
- [x] 確認記録一覧のフィルターUI改善（カード式レイアウト）
- [x] ステータスフィルターの視覚的改善（選択状態の明確化）
- [x] ホバー時のカーソル変更（PDF/CSV/ステータスボタン）
- [x] チェックリスト編集ボタンの配置最適化
- [x] フィルタークリア機能の追加
- [x] ボタン配置の最適化（削除ボタンをサマリーページに配置）

#### 8-2. レスポンシブ対応の強化
- [ ] モバイル画面の最適化
- [ ] タブレット画面の最適化
- [ ] タッチ操作の改善

#### 8-3. パフォーマンス最適化
- [ ] 画像の遅延読み込み
- [ ] データのキャッシング
- [ ] ページ読み込み速度の改善

#### 8-4. アクセシビリティ
- [ ] キーボード操作対応
- [ ] スクリーンリーダー対応
- [ ] コントラスト比の改善

**推定工数**: 1週間（一部完了）

---

### Phase 9: 追加機能（オプション）

#### 9-1. 通知機能
- [ ] メール通知
- [ ] アプリ内通知
- [ ] 通知設定

#### 9-2. 検索機能
- [ ] 全文検索
- [ ] 高度な絞り込み
- [ ] 保存された検索条件

#### 9-3. ダッシュボードの強化
- [ ] ダッシュボードのウィジェット
- [ ] グラフ・統計情報
- [ ] 最近のアクティビティ

#### 9-4. 監査ログ
- [ ] 操作履歴の記録
- [ ] ログの閲覧
- [ ] セキュリティ監査

**推定工数**: 2-3週間

---

## 推奨開発順序

### ✅ 完了済み
- **Phase 0-2**: 基盤構築〜マスターデータ管理
- **Phase 6**: レポート機能（統計ダッシュボード、グラフ、PDF/CSV出力）

### 🔥 最優先（直近1ヶ月）
1. **Phase 5（残タスク）**: 多段承認フローの通知・リマインド、承認待ちキュー改善を行う

→ ここまででMVP〜β版の要件を満たし、現地確認〜承認〜レポート出力までをひと通り運用可能

### 📊 次のステップ（1-2ヶ月）
2. **Phase 7**: 組織・ユーザー管理（管理部門向け機能）
3. **Phase 8**: UI/UX改善・パフォーマンス最適化

→ 本格的な運用フェーズで求められる管理系機能と改善

### 🎨 改善・拡張（継続的）
4. **Phase 9**: 通知・検索・ダッシュボード等の追加機能

---

## 技術的な課題と対策

### 1. 写真アップロード
**課題**: 大量の写真のストレージと帯域幅
**対策**:
- Supabase Storageの使用
- 画像の自動圧縮
- 遅延読み込み

### 2. PDF生成
**課題**: サーバーサイドでのPDF生成のパフォーマンス
**対策**:
- クライアントサイドでの生成（react-pdf）
- バックグラウンドジョブ（将来的）

### 3. 承認フロー
**課題**: 複雑な承認ロジックの実装
**対策**:
- ステートマシンパターンの採用
- RLSポリシーでの権限制御

### 4. リアルタイム更新
**課題**: 複数ユーザーの同時編集
**対策**:
- Supabase Realtimeの活用（将来的）
- 楽観的ロックの実装

---

## マイルストーン

### マイルストーン 1: MVP リリース（2ヶ月後）
- 確認記録の作成・保存・閲覧
- 基本テンプレートの使用
- 写真アップロード
- 基本的なレポート表示

### マイルストーン 2: β版リリース（3ヶ月後）
- 承認フロー機能
- PDF出力
- ユーザー管理

### マイルストーン 3: 正式版リリース（4-5ヶ月後）
- 全機能の実装
- UI/UX改善
- パフォーマンス最適化

---

## 次の作業

**最優先で実装すべき機能**:

1. **承認設定と通知（Phase 5）**
   - 多段承認レベルと承認者の割当UI
   - 権限ロール管理と承認待ちのリマインド通知
   - 承認設定のテストデータ整備 + 監査用ログの強化

2. **組織・ユーザー管理（Phase 7）**
   - ユーザー一覧とユーザー招待機能
   - 組織設定画面（承認レベル設定など）
   - プロフィール編集機能

3. **UI/UX最適化と検索拡張（Phase 8-9）**
   - 一覧/詳細画面のレスポンシブ最適化
   - 一括検索・保存済みフィルタなどの検索拡充
   - ダッシュボード強化と通知の拡張

これらを完了すると、現地確認〜承認〜レポート出力までを実務レベルで完全運用可能な状態になります。

---

**作成日**: 2025-01-18
**最終更新**: 2025-11-20

---

## 🎉 最近の更新（2025-11-20）

### UI/UX改善
- 確認記録一覧のフィルターUIを全面刷新（カード式レイアウト、視覚的な改善）
- ホバー時のカーソル変更を実装（PDF/CSV/ステータスボタン）
- チェックリスト編集ボタンをチェックリストセクション内に移動
- フィルタークリア機能を追加

### 削除機能の実装
- 下書きの確認記録を作成者のみ削除可能に
- サマリーページに削除ボタンを配置（PDF/CSVボタンの並び）
- 削除確認ダイアログの実装

### 承認申請の改善
- サマリーページから直接承認申請が可能に
- 必須項目の自動バリデーション（チェックリスト項目 + 確認実施日）
- 承認申請確認ダイアログの実装

### レイアウト統一
- DashboardLayoutを全認証後ページに適用
- LAYOUT-GUIDE.mdを作成し、レイアウト使用方法を文書化
- ナビゲーションメニューを整理（承認待ちメニュー削除）

### エクスポート機能の最適化
- CSV出力から不要な「項目タイプ」列を削除
